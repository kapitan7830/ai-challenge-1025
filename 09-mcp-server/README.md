# 🎭 Анализатор персонажей с поддержкой MCP

> Telegram бот и MCP сервер для анализа персонажей в художественных текстах с автоматической суммаризацией длинных текстов

## 🚀 Быстрый старт

Проект работает в **двух режимах**:

### 1️⃣ MCP Server (новое - рекомендуется)

```bash
# Показать список MCP инструментов (без установки)
npm run help

# Или полная демонстрация (требует npm install)
npm run mcp-client
```

### 2️⃣ Telegram Bot (классический режим)

```bash
# Установить зависимости
npm install

# Создать .env файл с токенами
TELEGRAM_BOT_TOKEN=your_token
YANDEX_API_KEY=your_key
YANDEX_FOLDER_ID=your_folder

# Запустить бота
npm start
```

---

## 📖 Что это?

### MCP (Model Context Protocol)

**MCP = USB для AI** - открытый стандарт от Anthropic для подключения инструментов к AI моделям.

**Преимущества:**
- ✅ Работает с Claude Desktop из коробки
- ✅ Универсальный протокол для любых клиентов
- ✅ Стандартизированный API
- ✅ Легко расширять и интегрировать

**4 MCP инструмента:**
1. `analyze_characters` - Анализ персонажей с психологическими портретами
2. `summarize_text` - Суммаризация длинных текстов
3. `estimate_tokens` - Оценка количества токенов
4. `check_token_limit` - Проверка превышения лимита

### Telegram Bot

Классический бот для анализа персонажей через Telegram:
- Принимает тексты от пользователей
- Автоматически суммаризирует длинные тексты
- Возвращает список персонажей с характеристиками
- Показывает детальную статистику (токены, время, стоимость)

---

## 🎯 Как запустить?

### Вариант А: MCP Server

#### Быстрая демонстрация (0 секунд установки)
```bash
npm run help
```
Покажет список всех 4 MCP инструментов.

#### Полная демонстрация с подключением
```bash
# Шаг 1: Установка
npm install

# Шаг 2: Запустить сервер (терминал 1)
npm run mcp-server

# Шаг 3: Запустить клиент (терминал 2)
npm run mcp-client
```

Клиент подключится к серверу, получит список инструментов и выполнит демо-вызовы.

#### Интеграция с Claude Desktop
Добавьте в `~/Library/Application Support/Claude/claude_desktop_config.json`:

```json
{
  "mcpServers": {
    "character-analyzer": {
      "command": "node",
      "args": ["/absolute/path/to/mcp/server.js"],
      "env": {
        "YANDEX_API_KEY": "your_key",
        "YANDEX_FOLDER_ID": "your_folder"
      }
    }
  }
}
```

Перезапустите Claude Desktop. Теперь можно писать:
```
Проанализируй персонажей в тексте: "Маша шла по лесу..."
```

### Вариант Б: Telegram Bot

```bash
# 1. Установка зависимостей
npm install

# 2. Создайте .env файл
cat > .env << EOF
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
YANDEX_API_KEY=your_yandex_api_key
YANDEX_FOLDER_ID=your_yandex_folder_id
EOF

# 3. Запустите бота
npm start
```

#### Использование в Telegram:
1. `/start` - начать новую сессию
2. Отправьте текст рассказа (можно несколькими сообщениями)
3. `/finish` - завершить ввод и начать анализ
4. `/cancel` - отменить текущую сессию

---

## 📁 Структура проекта

```
📦 Проект
│
├── 🔧 MCP (новое)
│   ├── mcp/server.js          # MCP сервер
│   ├── mcp/client.js          # MCP клиент (демо)
│   └── mcp/test-simple.js     # Демо без зависимостей
│
├── 📱 Telegram Bot (классика)
│   └── index.js               # Telegram бот
│
├── 🤖 Агенты (общие для обоих режимов)
│   └── agents/CharacterAnalyzerAgent.js
│
├── 🛠️ Утилиты (общие)
│   ├── utils/TextSummarizer.js
│   └── utils/TokenCounter.js
│
└── 📚 Документация
    ├── START-HERE.md          # Навигация (начните здесь!)
    ├── MCP-GUIDE.md           # Полное руководство по MCP
    ├── COMPLETE-SOLUTION.md   # Решение с кодом
    ├── QUICK-START.md         # Быстрый старт
    ├── MCP-SUMMARY.md         # Краткое резюме
    ├── INSTALL-MCP.md         # Установка и настройка
    └── ARCHITECTURE.md        # Архитектура (старая)
```

---

## 📚 Документация

### 🏃 Для торопящихся
- **[QUICK-START.md](./QUICK-START.md)** - команды и результаты за 30 секунд
- **[START-HERE.md](./START-HERE.md)** - навигация по проекту, выберите свой путь

### 🎓 Для изучающих MCP
- **[MCP-GUIDE.md](./MCP-GUIDE.md)** - что такое MCP, зачем нужен, как работает (10 мин)
- **[MCP-SUMMARY.md](./MCP-SUMMARY.md)** - краткое резюме выполненной задачи (3 мин)

### 💻 Для разработчиков
- **[COMPLETE-SOLUTION.md](./COMPLETE-SOLUTION.md)** - полное решение с кодом (20 мин)
- **[ARCHITECTURE.md](./ARCHITECTURE.md)** - архитектура проекта (для Telegram бота)

### 🔧 Для внедрения
- **[INSTALL-MCP.md](./INSTALL-MCP.md)** - пошаговая установка и настройка (20 мин)
- **[TASK-COMPLETED.md](./TASK-COMPLETED.md)** - отчет о выполнении задачи

---

## 🔧 Доступные команды

### MCP режим
```bash
npm run help         # Показать список MCP инструментов
npm run mcp-demo     # То же что help
npm run mcp-server   # Запустить MCP сервер
npm run mcp-client   # Запустить тестовый MCP клиент
```

### Telegram режим
```bash
npm start            # Запустить Telegram бота
npm run dev          # Запустить бота в режиме разработки (с hot reload)
```

---

## 💡 Сравнение режимов

| Критерий | Telegram Bot | MCP Server |
|----------|--------------|------------|
| **Для кого** | Обычные пользователи | Разработчики, AI ассистенты |
| **Интерфейс** | Telegram чат | Программный API |
| **Claude Desktop** | ❌ Нет | ✅ Да |
| **Расширяемость** | ❌ Сложно | ✅ Легко |
| **Использование** | Публичный доступ | Интеграции, автоматизация |
| **Стандартизация** | Кастомный API | MCP протокол |

---

## 🎯 Примеры использования

### MCP Server

#### Пример 1: Просмотр инструментов
```bash
npm run help
```

#### Пример 2: Полная демонстрация
```bash
npm run mcp-client
```

#### Пример 3: Использование в Claude Desktop
```
Проанализируй персонажей в этом тексте:
"Маша шла по лесу и встретила волка по имени Серый..."
```
Claude автоматически вызовет MCP инструмент `analyze_characters`.

### Telegram Bot

#### Пример 1: Короткий текст
```
/start
Маша шла по лесу. Встретила волка.
/finish

→ Анализ персонажей за 1-2 сек
→ ~200 токенов, ~0.06₽
```

#### Пример 2: Длинный текст
```
/start
[рассказ на 15000 символов...]
/finish

→ Автоматическая суммаризация
→ Анализ персонажей
→ ~6000 токенов, ~2₽, время ~30 сек
```

---

## 🏗️ Архитектура

### MCP режим
```
Claude Desktop / CLI / Web App
            ↓
      MCP Client
            ↓
      MCP Server (mcp/server.js)
            ↓
    ┌───────┴────────┐
    ↓                ↓
Agents            Utils
(Char Analyzer)   (Token Counter)
```

### Telegram режим
```
Telegram User
      ↓
   Bot (index.js)
      ↓
  ┌───┴────┐
  ↓        ↓
Agents   Utils
```

---

## 🔑 Настройка окружения

Создайте `.env` файл в корне проекта:

```bash
# Для Telegram бота (обязательно если используете бота)
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_from_@BotFather

# Для YandexGPT (обязательно для обоих режимов)
YANDEX_API_KEY=your_yandex_cloud_api_key
YANDEX_FOLDER_ID=your_yandex_cloud_folder_id
```

### Где получить токены:

**Telegram Bot Token:**
1. Найдите [@BotFather](https://t.me/botfather) в Telegram
2. Отправьте `/newbot`
3. Следуйте инструкциям
4. Скопируйте токен

**Yandex Cloud:**
1. Зарегистрируйтесь в [Yandex Cloud](https://cloud.yandex.ru/)
2. Создайте сервисный аккаунт
3. Получите API ключ
4. Скопируйте Folder ID

---

## ⚠️ Возможные проблемы

### npm install не работает
```bash
# Очистите кэш
sudo chown -R $(whoami) ~/.npm
npm cache clean --force
npm install
```

### MCP клиент не подключается
Убедитесь что:
1. Сервер запущен: `npm run mcp-server`
2. API ключи в `.env` правильные
3. Используете Node.js >= 18

### Telegram бот не отвечает
Проверьте:
1. Токен бота в `.env` правильный
2. Бот запущен: `npm start`
3. В консоли нет ошибок

---

## 📊 Возможности

### Общие (для обоих режимов)
- ✅ Анализ персонажей с психологическими портретами
- ✅ Автоматическая суммаризация длинных текстов (>6000 токенов)
- ✅ Подсчет токенов и стоимости
- ✅ Сохранение всех персонажей при суммаризации
- ✅ Детальная статистика

### MCP эксклюзивно
- ✅ Работа с Claude Desktop
- ✅ Программный API
- ✅ Стандартизированный протокол
- ✅ Автоматическая валидация (Zod)
- ✅ 4 независимых инструмента

### Telegram эксклюзивно
- ✅ Публичный доступ
- ✅ Сессии пользователей
- ✅ Многосообщения
- ✅ Красивый форматированный вывод

---

## 🎓 Технологии

- **Node.js** (>= 18) - runtime
- **Telegraf** - Telegram Bot API
- **YandexGPT-lite** - LLM для анализа и суммаризации
- **@modelcontextprotocol/sdk** - MCP протокол
- **Zod** - валидация схем
- **dotenv** - переменные окружения

---

## 📈 Производительность

| Длина текста | Токены | Время | Стоимость |
|--------------|--------|-------|-----------|
| Короткий     | ~200   | 1-2с  | ~0.06₽    |
| Средний      | ~2000  | 3-5с  | ~0.6₽     |
| Длинный      | ~5000  | 10-15с| ~1.5₽     |
| Очень длинный| ~15000 | 30-40с| ~4.5₽     |

*При использовании суммаризации для длинных текстов*

---

## 🚀 Следующие шаги

### Для MCP:
1. Прочитайте **[MCP-GUIDE.md](./MCP-GUIDE.md)** - поймете зачем нужен MCP
2. Запустите `npm run mcp-client` - увидите как работает
3. Настройте Claude Desktop - используйте в работе
4. Добавьте свои инструменты

### Для Telegram:
1. Создайте бота через @BotFather
2. Настройте `.env` файл
3. Запустите `npm start`
4. Поделитесь ботом с друзьями

---

## 📝 Лицензия

ISC

---

## 🤝 Вопросы?

- **Не знаете с чего начать?** → Откройте **[START-HERE.md](./START-HERE.md)**
- **Хотите быстро протестировать?** → Запустите `npm run help`
- **Нужна полная информация об MCP?** → Читайте **[MCP-GUIDE.md](./MCP-GUIDE.md)**
- **Хотите разобрать код?** → Смотрите **[COMPLETE-SOLUTION.md](./COMPLETE-SOLUTION.md)**

---

**Начните с команды `npm run help` прямо сейчас!** 🚀
