import OpenAI from 'openai';
import { logger } from '../utils/logger.js';

export class ZoologistAgent {
  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });
    this.model = 'gpt-4o-mini';
  }
  
  async getReports(animals) {
    const reports = [];
    
    for (let i = 0; i < animals.length; i++) {
      logger.info(`ðŸ”¬ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ñ€Ð°Ð²ÐºÐ¸ ${i + 1}/${animals.length}: ${animals[i].name}`);
      
      const report = await this.analyzeAnimal(animals[i]);
      reports.push(report);
    }
    
    return reports;
  }
  
  async analyzeAnimal(animal) {
    const prompt = `Ð¢Ñ‹ Ð±Ð¸Ð¾Ð»Ð¾Ð³ Ð¸ Ð·Ð¾Ð¾Ð»Ð¾Ð³. ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²ÑŒ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ Ð½Ð°ÑƒÑ‡Ð½ÑƒÑŽ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ Ð¾ Ð¶Ð¸Ð²Ð¾Ñ‚Ð½Ð¾Ð¼: ${animal.name}

ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ: ${animal.context}

ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ Ð°ÑÐ¿ÐµÐºÑ‚Ð°Ð¼:

1. **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: Ð²Ñ‹Ð¼ÐµÑ€Ð»Ð¾ Ð¸Ð»Ð¸ Ð½ÐµÑ‚
2. **ÐœÐ¾Ñ€Ñ„Ð¾Ñ„Ð¸Ð·Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ**: ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ»Ð°, Ñ„Ð¸Ð·Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ, Ð³ÐµÐ½ÐµÑ‚Ð¸ÐºÐ° (ÐºÑ€Ð°Ñ‚ÐºÐ¾)
3. **Ð‘Ð¸Ð¾Ñ…Ð¸Ð¼Ð¸Ñ**: Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¼ÐµÑ‚Ð°Ð±Ð¾Ð»Ð¸Ð·Ð¼Ð° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ)
4. **ÐŸÐ¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ**: ÑÐ¿Ð¾ÑÐ¾Ð±Ñ‹ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ, Ñ€Ð°Ð·Ð¼Ð½Ð¾Ð¶ÐµÐ½Ð¸Ñ, Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
5. **ÐÑ€ÐµÐ°Ð» Ð¾Ð±Ð¸Ñ‚Ð°Ð½Ð¸Ñ**: Ð³Ð´Ðµ Ð¶Ð¸Ð²ÐµÑ‚ Ð¸Ð»Ð¸ Ð¶Ð¸Ð»Ð¾
6. **Ð¡ÐºÑ€ÐµÑ‰Ð¸Ð²Ð°Ð½Ð¸Ðµ**: ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ Ðº Ð²Ð·Ð°Ð¸Ð¼Ð¾ÑÐºÑ€ÐµÑ‰Ð¸Ð²Ð°Ð½Ð¸ÑŽ Ñ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð¿Ð»Ð¾Ð´Ð¾Ð²Ð¸Ñ‚Ð¾Ð³Ð¾ Ð¿Ð¾Ñ‚Ð¾Ð¼ÑÑ‚Ð²Ð°

Ð’ÐÐ–ÐÐž:
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð¾ÑÑ‚Ð¾Ð²ÐµÑ€Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
- Ð•ÑÐ»Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÐºÐ°ÐºÐ¾Ð¼Ñƒ-Ñ‚Ð¾ Ð¿ÑƒÐ½ÐºÑ‚Ñƒ Ð½ÐµÑ‚ - Ð½Ð°Ð¿Ð¸ÑˆÐ¸ "Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð½ÐµÑ‚"
- ÐÐµ Ð²Ñ‹Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ Ð´Ð°Ð½Ð½Ñ‹Ðµ
- Ð‘ÑƒÐ´ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¼ Ð½Ð¾ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¼

Ð’ÐµÑ€Ð½Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¡Ð¢Ð ÐžÐ“Ðž Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ JSON:
{
  "animal": "Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ",
  "status": "Ð²Ñ‹Ð¼ÐµÑ€ÑˆÐµÐµ/ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ",
  "morphophysiology": "Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ 'Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð½ÐµÑ‚'",
  "biochemistry": "Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ 'Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð½ÐµÑ‚'",
  "behavior": "Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ 'Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð½ÐµÑ‚'",
  "habitat": "Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ 'Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð½ÐµÑ‚'",
  "crossbreeding": "Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ 'Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð½ÐµÑ‚'"
}`;

    try {
      const response = await this.openai.chat.completions.create({
        model: this.model,
        messages: [
          {
            role: 'system',
            content: 'Ð¢Ñ‹ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð¸Ð¾Ð»Ð¾Ð³ Ð¸ Ð·Ð¾Ð¾Ð»Ð¾Ð³. ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑˆÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð¾ÑÑ‚Ð¾Ð²ÐµÑ€Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ JSON.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.2,
        response_format: { type: 'json_object' }
      });
      
      const content = response.choices[0].message.content;
      
      // ÐŸÐ°Ñ€ÑÐ¸Ð¼ JSON
      let parsed;
      try {
        parsed = JSON.parse(content);
      } catch (e) {
        logger.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° JSON Ð´Ð»Ñ ${animal.name}: ${e.message}`);
        return {
          animal: animal.name,
          error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°'
        };
      }
      
      return parsed;
      
    } catch (error) {
      logger.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð·Ðµ ${animal.name}: ${error.message}`);
      return {
        animal: animal.name,
        error: error.message
      };
    }
  }
}

